name: CI Pipeline

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create .env file from secrets
      run: |
        cat > .env << EOF
        # Europe PMC (polite usage / log purposes)
        EUROPE_PMC_EMAIL=drmahirkurt@gmail.com

        # ==========================================
        # API KEYS & CONFIGURATION
        # ==========================================

        # ----- Perplexity AI -----
        PERPLEXITY_API_KEY=${{ secrets.PERPLEXITY_API_KEY }}
        PERPLEXITY_MODEL=sonar

        # ----- OpenAI -----
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        OPENAI_BASE_URL=https://api.openai.com/v1

        # ----- Confident AI -----
        CONFIDENT_AI_PROJECT_ID=${{ secrets.CONFIDENT_AI_PROJECT_ID }}
        CONFIDENT_AI_API_KEY=${{ secrets.CONFIDENT_AI_API_KEY }}

        # ----- PubMed -----
        PUBMED_API_KEY=${{ secrets.PUBMED_API_KEY }}
        PUBMED_EMAIL=drmahirkurt@gmail.com

        # ----- Elsevier (Scopus/Embase/ScienceDirect) -----
        ELSEVIER_API_KEY=${{ secrets.ELSEVIER_API_KEY }}
        ELSEVIER_EMAIL=mahir.kurt@roche.com

        # ----- GitHub -----
        # GITHUB_PERSONAL_ACCESS_TOKEN stored in GitHub Secrets (cannot use GITHUB_ prefix)

        # ==========================================
        # MODEL CONFIGURATION
        # ==========================================
        FACTL_LLM_MODEL=gpt-4o
        DEEPEVAL_MODEL=gpt-4o

        # ----- Semantic Scholar -----
        SEMANTIC_SCHOLAR_API_KEY=${{ secrets.SEMANTIC_SCHOLAR_API_KEY }}

        # ----- Wiley -----
        WILEY_TDM_CLIENT_TOKEN=${{ secrets.WILEY_TDM_CLIENT_TOKEN }}

        # ----- OpenAlex -----
        OPENALEX_API_KEY=${{ secrets.OPENALEX_API_KEY }}
        OPENALEX_EMAIL=drmahirkurt@gmail.com
        EOF

    - name: Test API connections
      run: |
        echo "Testing API key availability..."
        if [ -n "$PERPLEXITY_API_KEY" ]; then echo "✓ Perplexity API key available"; else echo "✗ Perplexity API key missing"; fi
        if [ -n "$OPENAI_API_KEY" ]; then echo "✓ OpenAI API key available"; else echo "✗ OpenAI API key missing"; fi
        if [ -n "$PUBMED_API_KEY" ]; then echo "✓ PubMed API key available"; else echo "✗ PubMed API key missing"; fi
        if [ -n "$ELSEVIER_API_KEY" ]; then echo "✓ Elsevier API key available"; else echo "✗ Elsevier API key missing"; fi
        if [ -n "$SEMANTIC_SCHOLAR_API_KEY" ]; then echo "✓ Semantic Scholar API key available"; else echo "✗ Semantic Scholar API key missing"; fi
        if [ -n "$WILEY_TDM_CLIENT_TOKEN" ]; then echo "✓ Wiley TDM token available"; else echo "✗ Wiley TDM token missing"; fi
        if [ -n "$OPENALEX_API_KEY" ]; then echo "✓ OpenAlex API key available"; else echo "✗ OpenAlex API key missing"; fi
      env:
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PUBMED_API_KEY: ${{ secrets.PUBMED_API_KEY }}
        ELSEVIER_API_KEY: ${{ secrets.ELSEVIER_API_KEY }}
        SEMANTIC_SCHOLAR_API_KEY: ${{ secrets.SEMANTIC_SCHOLAR_API_KEY }}
        WILEY_TDM_CLIENT_TOKEN: ${{ secrets.WILEY_TDM_CLIENT_TOKEN }}
        OPENALEX_API_KEY: ${{ secrets.OPENALEX_API_KEY }}

    - name: Run basic tests
      run: |
        python -c "import sys; print('Python version:', sys.version)"
        python -c "import requests; print('✓ Requests library available')"
        python -c "import bs4; print('✓ BeautifulSoup library available')"